<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한국 청교도 연구소 | Korea Puritan Institute</title>
    <meta name="description" content="청교도 신학과 개혁주의 신념을 연구하고 성경적인 자료를 제공하는 한국 청교도 연구소입니다.">

    <!-- Open Graph / KakaoTalk / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kpuritan.com/">
    <meta property="og:title" content="한국 청교도 연구소 | Korea Puritan Institute">
    <meta property="og:description" content="청교도 신학과 개혁주의 신념을 연구하고 성경적인 자료를 제공하는 한국 청교도 연구소입니다.">
    <meta property="og:image" content="og-image.png?v=4">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://kpuritan.com/">
    <meta property="twitter:title" content="한국 청교도 연구소 | Korea Puritan Institute">
    <meta property="twitter:description" content="청교도 신학과 개혁주의 신념을 연구하고 성경적인 자료를 제공하는 한국 청교도 연구소입니다.">
    <meta property="twitter:image" content="og-image.png?v=4">

    <link rel="stylesheet" href="style.css?v=102">
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg?v=2">
    <link rel="icon" type="image/x-icon" href="favicon.ico?v=2">
    <link rel="icon" type="image/png" href="favicon.png?v=2">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png?v=2">
    <!-- Font Awesome for Search Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <div class="nav-overlay"></div>

    <header>
        <div class="nav-container">
            <a href="#" class="logo">
                <span class="logo-eng">KPI</span>
                <span class="logo-kor">한국 청교도 연구소</span>
            </a>
            <button class="mobile-menu-toggle" aria-label="메뉴 열기">
                <i class="fas fa-bars"></i>
            </button>
            <nav>
                <ul>
                    <li><a href="#about">About</a></li>
                    <li><a href="#recent-updates">Resources</a></li>

                    <li class="dropdown">
                        <a href="javascript:void(0)" onclick="openAllTopicsModal()">주제별 자료 <i
                                class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content mega-menu" id="topic-dropdown">
                            <!-- Topics injected here -->
                        </div>
                    </li>
                    <li class="dropdown">
                        <a href="javascript:void(0)" onclick="openAllAuthorsModal()">저자별 자료 <i
                                class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content mega-menu" id="author-dropdown">
                            <div class="author-search-container">
                                <input type="text" id="author-dropdown-search" placeholder="저자 이름 검색...">
                            </div>
                            <div class="author-grid-dropdown" id="author-dropdown-grid">
                                <!-- Authors injected here -->
                            </div>
                        </div>
                    </li>
                    <li><a href="javascript:void(0)" onclick="openResourceModal('강해설교')">강해설교</a></li>
                    <li><a href="javascript:void(0)" onclick="openResourceModal('전도 소책자')">전도 소책자</a></li>
                    <li class="dropdown">
                        <a href="javascript:void(0)">퓨리탄헤리티지북스(PHB) <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown-content" id="publisher-dropdown">
                            <ul class="dropdown-list">
                                <li><a href="books.html">도서 목록</a></li>
                                <li><a href="mailto:kpuritan.phb@gmail.com">메일 문의</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </nav>
            <div class="header-right">
                <div class="search-bar">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" placeholder="검색어를 입력하세요...">
                </div>
            </div>
        </div>
    </header>

    <main>
        <section class="hero">
            <div class="hero-content">
                <h1>KOREA PURITAN <br>INSTITUTE</h1>
                <p>Puritan theology, <br>modern research.</p>
                <div class="hero-btns">
                    <a href="#recent-updates" class="cta-btn primary">EXPLORE OUR RESEARCH</a>
                </div>
            </div>
        </section>

        <!-- About Section Moved to Modal -->







        <section id="recent-updates">
            <div class="section-title modern-flex" style="margin-bottom: 2rem; border-bottom: none;">
                <div class="title-text-group">
                    <h2>EXPLORE RESOURCES</h2>
                    <p>Discover our curated library of Reformed theology.</p>
                </div>
            </div>

            <!-- 1. New Arrivals Carousel -->
            <div class="carousel-section">
                <div class="carousel-header">
                    <h3 class="carousel-title">최신 업데이트 <span
                            style="font-size:0.5em; color:#999; font-weight:500; margin-left:10px;">New Arrivals</span>
                    </h3>
                    <a href="javascript:void(0)" onclick="openAllRecentModal()" class="carousel-view-all">전체보기 <i
                            class="fas fa-chevron-right"></i></a>
                </div>
                <div class="carousel-container-wrapper">
                    <button class="carousel-nav-btn prev" onclick="scrollCarousel('carousel-new', -300)"><i
                            class="fas fa-chevron-left"></i></button>
                    <div class="carousel-track" id="carousel-new">
                        <!-- JS injected cards -->
                        <div class="loading-msg" style="padding:2rem;">최신 자료를 불러오는 중...</div>
                    </div>
                    <button class="carousel-nav-btn next" onclick="scrollCarousel('carousel-new', 300)"><i
                            class="fas fa-chevron-right"></i></button>
                </div>
            </div>

            <!-- 2. Featured Topics Carousel -->
            <div class="carousel-section">
                <div class="carousel-header">
                    <h3 class="carousel-title">주제별 추천 자료 <span
                            style="font-size:0.5em; color:#999; font-weight:500; margin-left:10px;">Featured
                            Topics</span></h3>
                    <a href="javascript:void(0)" onclick="openAllTopicsModal()" class="carousel-view-all">주제 목록 더보기 <i
                            class="fas fa-chevron-right"></i></a>
                </div>
                <div class="carousel-container-wrapper">
                    <button class="carousel-nav-btn prev" onclick="scrollCarousel('carousel-topic', -300)"><i
                            class="fas fa-chevron-left"></i></button>
                    <div class="carousel-track" id="carousel-topic">
                        <!-- JS injected cards -->
                        <div class="loading-msg" style="padding:2rem;">추천 자료를 불러오는 중...</div>
                    </div>
                    <button class="carousel-nav-btn next" onclick="scrollCarousel('carousel-topic', 300)"><i
                            class="fas fa-chevron-right"></i></button>
                </div>
            </div>

            <!-- 3. Expository Sermons Carousel -->
            <div class="carousel-section">
                <div class="carousel-header">
                    <h3 class="carousel-title">강해설교 시리즈 <span
                            style="font-size:0.5em; color:#999; font-weight:500; margin-left:10px;">Sermon Series</span>
                    </h3>
                    <a href="javascript:void(0)" onclick="openResourceModal('강해설교')" class="carousel-view-all">시리즈 전체보기
                        <i class="fas fa-chevron-right"></i></a>
                </div>
                <div class="carousel-container-wrapper">
                    <button class="carousel-nav-btn prev" onclick="scrollCarousel('carousel-sermon', -300)"><i
                            class="fas fa-chevron-left"></i></button>
                    <div class="carousel-track" id="carousel-sermon">
                        <!-- JS injected cards -->
                        <div class="loading-msg" style="padding:2rem;">설교 시리즈를 불러오는 중...</div>
                    </div>
                    <button class="carousel-nav-btn next" onclick="scrollCarousel('carousel-sermon', 300)"><i
                            class="fas fa-chevron-right"></i></button>
                </div>
            </div>

        </section>
        </section>

        <script>
            // Emergency Fallback for Carousels
            setTimeout(() => {
                const checkAndFill = (id) => {
                    const track = document.getElementById(id);
                    // 내용이 없거나 loading-msg만 있으면 fallback 실행
                    if (track && (track.children.length === 0 || track.querySelector('.loading-msg'))) {
                        console.warn(`Fallback triggered for ${id}`);
                        track.innerHTML = '';
                        const mockData = [
                            { title: "[샘플] 청교도 신학의 정수", cat: "청교도 신학", date: "2026.01.15" },
                            { title: "[샘플] 웨스트민스터 신앙고백 해설", cat: "신앙고백", date: "2026.01.12" },
                            { title: "[샘플] 리처드 십스의 상한 갈대", cat: "경건 서적", date: "2026.01.10" },
                            { title: "[샘플] 가정 예배 지침서", cat: "신자의 삶", date: "2026.01.05" },
                            { title: "[샘플] 은혜의 수단으로서의 기도", cat: "청교도 신학", date: "2026.01.03" },
                            { title: "[샘플] 참된 회심의 성경적 표지", cat: "회심", date: "2026.01.01" },
                            { title: "[샘플] 그리스도의 위격과 사역", cat: "기독론", date: "2025.12.28" },
                            { title: "[샘플] 성화의 신비와 능력", cat: "성화", date: "2025.12.25" }
                        ];

                        mockData.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'carousel-card';
                            div.innerHTML = `
                                <div class="carousel-card-content">
                                    <div class="carousel-card-tag">${item.cat}</div>
                                    <div class="carousel-card-title">${item.title}</div>
                                    <div class="carousel-card-meta">
                                        <span>${item.date}</span>
                                        <div class="carousel-icon-btn"><i class="fas fa-arrow-right"></i></div>
                                    </div>
                                </div>
                            `;
                            div.onclick = () => {
                                try {
                                    if (window.openResourceModal) {
                                        window.openResourceModal(item.cat);
                                    } else {
                                        // 급한대로 제목만이라도 보여주는 fallback
                                        console.warn("Main Script Not Loaded - Basic Alert");
                                        // alert("상세 보기 기능 로딩 중... (Main Script Not Loaded)\n제목: " + post.title); // post.title이 아니라 item.title이 맞음
                                        openLocalMockModal(item.cat, item.title); // Fallback to local mock modal
                                    }
                                } catch (e) {
                                    console.warn("Using local modal fallback:", e);
                                    openLocalMockModal(item.cat, item.title);
                                }
                            };
                            track.appendChild(div);
                        });
                    }
                };

                // 자체 로컬 모달 오픈 함수 (Main.js 의존성 제거)
                const openLocalMockModal = (cat, clickedTitle) => {
                    const modal = document.getElementById('resource-modal');
                    const list = document.getElementById('resource-list-container');
                    const title = document.getElementById('resource-modal-title');

                    if (modal && list) {
                        modal.classList.add('show');
                        if (title) title.textContent = cat + " 자료 목록 (샘플)";
                        list.innerHTML = '';

                        // 클릭한 아이템을 최상단에 보여줌
                        const li = document.createElement('li');
                        li.className = 'resource-item';
                        li.style.border = '2px solid var(--secondary-color)';
                        li.innerHTML = `
                            <div class="resource-header" style="margin-bottom:5px;">
                                <span style="font-size:0.8rem; color:var(--secondary-color);">샘플 자료</span>
                                <span style="font-size:0.8rem; color:#888;">2024.01.18</span>
                            </div>
                            <h3 style="margin:0 0 10px 0; font-size:1.1rem;">${clickedTitle || cat + ' 관련 자료'}</h3>
                            <p style="font-size:0.9rem; color:#555; margin-bottom: 15px;">
                                본 자료는 샘플 데이터입니다. (데이터베이스 연결 대기 중)<br>
                                만약 계속 이 화면이 보인다면 아래 버튼을 눌러보세요.
                            </p>
                            <div style="display:flex; gap:10px; margin-bottom:15px;">
                                <button onclick="window.loadMainCarousels ? window.loadMainCarousels() : alert('메인 스크립트가 아직 로드되지 않았습니다.');" 
                                    style="padding:8px 15px; background:var(--primary-color); color:white; border:none; border-radius:4px; cursor:pointer;">
                                    <i class="fas fa-sync-alt"></i> 실제 데이터 불러오기 (강제 시도)
                                </button>
                                <a href="#" class="premium-btn" style="display:inline-block; text-decoration:none; color:var(--secondary-color); border:1px solid var(--secondary-color); padding:8px 15px; border-radius:4px; font-size:0.9rem;">
                                    <i class="fas fa-file-pdf"></i> [샘플] PDF 디자인 예시
                                </a>
                            </div>
                        `;
                        list.appendChild(li);

                        // 추가 샘플들
                        const extras = ['심화 연구 자료', '관련 특강 영상', '참고 문헌 리스트'];
                        extras.forEach(ex => {
                            const eli = document.createElement('li');
                            eli.className = 'resource-item';
                            eli.innerHTML = `
                                <h4 style="margin:0 0 5px 0;">[샘플] ${cat} ${ex}</h4>
                                <p style="font-size:0.8rem; color:#999; margin-bottom:10px;">준비 중입니다.</p>
                                <button style="background:#eee; border:none; padding:5px 10px; border-radius:4px; color:#aaa; cursor:not-allowed;">
                                    <i class="fas fa-lock"></i> 접근 제한
                                </button>
                            `;
                            list.appendChild(eli);
                        });
                    } else {
                        alert("모달 요소를 찾을 수 없습니다. 페이지를 새로고침 해주세요.");
                    }
                };

                if (window.isDataLoaded) return; // 실제 데이터가 로드되었으면 샘플 덮어쓰기 방지
                checkAndFill('carousel-new');
                checkAndFill('carousel-topic');
                checkAndFill('carousel-sermon');
            }, 8000); // 8초 대기
        </script>

        <style>
            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            .load-more-trigger {
                width: 100%;
            }
        </style>

        <script>
            // Emergency Fallback: Standalone Mock Data Renderer
            // This script runs if the main logic fails to populate the grid within 1.5 seconds.
            setTimeout(() => {
                const grid = document.getElementById('recent-posts-grid');
                if (grid && grid.children.length === 0) {
                    console.warn("Emergency Fallback Triggered: Rendering Standalone Mock Data");

                    const mockData = [
                        { title: "청교도 신학의 정수: 존 오웬의 성령론", cat: "청교도 신학", date: "2026.01.15" },
                        { title: "현대 교회를 위한 웨스트민스터 신앙고백 해설", cat: "신앙고백", date: "2026.01.12" },
                        { title: "고난 속의 위로: 리처드 십스의 상한 갈대", cat: "경건 서적", date: "2026.01.10" },
                        { title: "설교란 무엇인가? 마틴 로이드 존스의 설교학", cat: "설교학", date: "2026.01.08" },
                        { title: "가정 예배의 회복과 실제적인 지침", cat: "신자의 삶", date: "2026.01.05" },
                        { title: "요한계시록 강해 시리즈 (1): 승리하신 그리스도", cat: "강해설교", date: "2026.01.01" }
                    ];

                    mockData.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'recent-card-premium';
                        div.innerHTML = `
                            <div class="recent-card-inner">
                                <div class="recent-card-top">
                                    <span class="recent-status-pill">SAMPLE</span>
                                    <span class="recent-category-tag">${item.cat}</span>
                                </div>
                                <h3 class="recent-title-premium">${item.title}</h3>
                                <div class="recent-card-footer">
                                    <span class="recent-date-premium"><i class="far fa-calendar-alt"></i> ${item.date}</span>
                                    <button class="recent-link-btn">
                                        상세보기 <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        div.querySelector('.recent-card-inner').addEventListener('click', () => {
                            if (window.openResourceModal) {
                                window.openResourceModal(item.cat);
                            } else {
                                console.warn("Main Script Not Loaded - Basic Alert");
                                // alert('자료 로딩 중입니다. 잠시만 기다려주세요.');
                            }
                        });
                        grid.appendChild(div);
                    });
                }
            }, 1500);
        </script>

        <section id="inquiry">
            <div class="inquiry-container">
                <div class="section-title">
                    <h2>문의와 연구소 세미나 소식 받기</h2>
                    <p>연구소 활동이나 세미나 소식에 대해 궁금한 점이 있으시면 남겨주세요. 뉴스레터 신청도 가능합니다.</p>
                </div>
                <form class="inquiry-form">
                    <div class="form-group">
                        <input type="text" placeholder="이름" required>
                        <input type="email" placeholder="이메일" required>
                    </div>
                    <input type="text" placeholder="제목" required>
                    <textarea placeholder="메시지 내용을 입력하세요" rows="5" required></textarea>
                    <button type="submit">보내기</button>
                </form>
            </div>
        </section>

        <!-- Admin Dashboard (Initially Hidden) -->
        <section id="admin-dashboard" class="admin-only section-hidden">
            <div class="admin-container">
                <div class="section-title left"
                    style="display: flex; justify-content: space-between; align-items: flex-start; border-top: none;">
                    <div>
                        <h2 style="margin-bottom: 0.5rem;">자료 관리 대시보드</h2>
                        <p>새로운 자료(글, 동영상, 파일)를 카테고리에 맞춰 업로드하세요.</p>
                        <p id="firebase-status"
                            style="font-size: 0.9em; margin-top: 0.5rem; color: var(--secondary-color);">연결 상태: 확인됨</p>
                    </div>
                    <button id="admin-logout-btn" class="cta-btn secondary"
                        style="padding: 0.6rem 1.2rem; font-size: 0.9rem; border-color: #e74c3c; color: #e74c3c; background: transparent;">
                        <i class="fas fa-sign-out-alt"></i> 로그아웃
                    </button>
                </div>

                <!-- 관리자 메뉴 선택 (3단 분리 포털) -->
                <div class="admin-portal-grid"
                    style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px; margin-top: 20px;">
                    <div class="admin-portal-card active" onclick="switchAdminTab('general')" id="tab-general"
                        style="background: #fff; padding: 25px; border-radius: 15px; border: 2px solid var(--primary-color); text-align: center; cursor: pointer; transition: all 0.3s; box-shadow: 0 10px 20px rgba(0,0,0,0.05);">
                        <i class="fas fa-book"
                            style="font-size: 2rem; color: var(--primary-color); margin-bottom: 15px;"></i>
                        <h3 style="margin-bottom: 5px; font-size: 1.1rem;">일반 자료 관리</h3>
                        <p style="font-size: 0.8rem; color: #666;">성경/주제/저자/기타</p>
                    </div>
                    <div class="admin-portal-card" onclick="switchAdminTab('bible-study')" id="tab-bible-study"
                        style="background: #fff; padding: 25px; border-radius: 15px; border: 2px solid #eee; text-align: center; cursor: pointer; transition: all 0.3s;">
                        <i class="fas fa-scroll"
                            style="font-size: 2rem; color: var(--secondary-color); margin-bottom: 15px;"></i>
                        <h3 style="margin-bottom: 5px; font-size: 1.1rem;">강해설교 관리</h3>
                        <p style="font-size: 0.8rem; color: #666;">시리즈 및 회차 관리</p>
                    </div>
                    <div class="admin-portal-card" onclick="switchAdminTab('booklet')" id="tab-booklet"
                        style="background: #fff; padding: 25px; border-radius: 15px; border: 2px solid #eee; text-align: center; cursor: pointer; transition: all 0.3s;">
                        <i class="fas fa-bullhorn" style="font-size: 2.5rem; color: #e67e22; margin-bottom: 15px;"></i>
                        <h3 style="margin-bottom: 5px; font-size: 1.1rem;">전도 소책자 관리</h3>
                        <p style="font-size: 0.8rem; color: #666;">소책자 전용 게시판</p>
                    </div>
                </div>

                <!-- 1. 일반 자료 섹션 -->
                <div class="admin-grid admin-tab-content" id="admin-general-section">
                    <form id="post-upload-form" class="upload-form"
                        style="background: #fff; border: 1px solid #eee; box-shadow: 0 10px 30px rgba(0,0,0,0.05);">
                        <div
                            style="background: var(--primary-color); color: white; padding: 15px 25px; border-radius: 12px 12px 0 0; margin: -25px -25px 25px -25px; display: flex; align-items: center; gap: 10px; margin-bottom: 25px;">
                            <i class="fas fa-edit"></i>
                            <h3 style="margin:0; font-size: 1.1rem; color: white;">일반 자료 관리하기</h3>
                        </div>

                        <div class="admin-form-tags-grid">

                            <div class="input-group">
                                <label>주제별 분류</label>
                                <select id="post-topic">
                                    <option value="">-- 선택 안함 --</option>
                                    <!-- Injected via JS -->
                                </select>
                            </div>
                            <div class="input-group">
                                <label>저자별 분류</label>
                                <select id="post-author">
                                    <option value="">-- 선택 안함 --</option>
                                    <!-- Injected via JS -->
                                </select>
                            </div>
                            <div class="input-group">
                                <label>기타 분류 (최신자료 전용)</label>
                                <select id="post-other-category">
                                    <option value="">-- 선택 안함 --</option>
                                    <option value="기타">기타 자료</option>
                                    <option value="도서 목록">도서 목록</option>
                                </select>
                            </div>
                        </div>

                        <div class="input-group">
                            <label>제목</label>
                            <input type="text" id="post-title" placeholder="자료 제목을 입력하세요" required>
                        </div>

                        <div class="input-row" style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                            <div class="input-group">
                                <label>시리즈/연재 이름 (폴더명 - 선택사항)</label>
                                <input type="text" id="post-series" placeholder="예: 요한복음 강해 시리즈, 청교도 역사 강의 등">
                            </div>
                            <div class="input-group">
                                <label>정렬 순서 (숫자)</label>
                                <input type="number" id="post-order" value="0">
                            </div>
                            <div class="input-group">
                                <label>가격 (도서 목록 전용)</label>
                                <input type="text" id="post-price" placeholder="예: 18,000원">
                            </div>
                        </div>

                        <div class="input-group">
                            <label>내용 (또는 유튜브 링크)</label>
                            <textarea id="post-content" rows="6" placeholder="내용을 입력하거나 유튜브 주소를 넣어주세요"></textarea>
                        </div>

                        <div class="input-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="input-group">
                                <label>도서 표지 이미지 (목록용)</label>
                                <input type="file" id="post-cover" accept="image/*" style="margin-bottom: 5px;">
                            </div>
                            <div class="input-group">
                                <label>도서 상세/내용 이미지 (본문용)</label>
                                <input type="file" id="post-file" style="margin-bottom: 5px;">
                            </div>
                        </div>
                        <p style="font-size: 0.8rem; color: #888; margin-bottom: 15px;">* 도서의 경우 '표지'와 '상세 이미지'를 각각 등록할
                            수 있습니다. (상세 이미지는 PDF도 가능)</p>

                        <div id="upload-progress-container"
                            style="display: none; width: 100%; margin: 15px 0; background: #fafafa; padding: 15px; border-radius: 8px; border: 1px solid #eee;">
                            <div
                                style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; font-weight: 700;">
                                <span id="upload-status-text" style="color: var(--secondary-color);">업로드 준비 중...</span>
                                <span id="upload-perc-text">0%</span>
                            </div>
                            <div class="progress-bar-bg"
                                style="width: 100%; height: 10px; background: #eee; border-radius: 5px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);">
                                <div id="upload-progress-bar"
                                    style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--secondary-color), #d4af37); transition: width 0.3s; box-shadow: 0 0 10px rgba(201, 156, 94, 0.5);">
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="cta-btn primary"
                            style="width: 100%; padding: 15px; font-size: 1.1rem;">자료 게시하기</button>

                    </form>
                </div>

                <!-- 2. 강해설교 시리즈 관리 섹션 -->
                <div class="admin-tab-content" id="admin-bible-study-section" style="display: none;">
                    <div
                        style="background: #fff; padding: 30px; border-radius: 15px; border: 1px solid #eee; box-shadow: 0 10px 30px rgba(0,0,0,0.05);">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                            <div>
                                <h3 style="margin:0; color: var(--primary-color);"><i class="fas fa-scroll"></i> 강해설교
                                    시리즈 관리</h3>
                                <p style="font-size: 0.9rem; color: #777; margin-top: 5px;">시리즈 폴더를 생성하고 설교 자료를 체계적으로
                                    관리하세요.</p>
                            </div>
                            <button class="cta-btn primary" onclick="createNewSeriesPrompt('강해설교')"
                                style="padding: 12px 25px;">
                                <i class="fas fa-folder-plus"></i> 새 시리즈(폴더) 만들기
                            </button>
                        </div>

                        <div id="admin-series-list-container" class="series-management-grid"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
                            <div class="loading-msg">시리즈 목록을 불러오는 중...</div>
                        </div>
                    </div>
                </div>

                <!-- 3. 전도 소책자 관리 섹션 -->
                <div class="admin-tab-content" id="admin-booklet-section" style="display: none;">
                    <div
                        style="background: #fff; padding: 30px; border-radius: 15px; border: 1px solid #eee; box-shadow: 0 10px 30px rgba(0,0,0,0.05);">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                            <h3 style="margin:0; color: #e67e22;"><i class="fas fa-bullhorn"></i> 전도 소책자 관리</h3>
                            <button class="cta-btn primary" onclick="openResourceModal('전도 소책자')"
                                style="background: #e67e22; border-color: #e67e22;">
                                <i class="fas fa-plus-circle"></i> 소책자 목록 보기/편집
                            </button>
                        </div>
                        <div id="admin-booklet-list-container">
                            <p style="text-align:center; color:#999; padding: 40px;">소책자 카드를 클릭하여 관리하거나 새 소책자를 추가하세요.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="admin-status">
                    <h3>최근 업로드 현황 (최대 100개)</h3>
                    <ul id="admin-recent-posts">
                        <li class="empty-msg">아직 업로드된 자료가 없습니다.</li>
                    </ul>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h4>Korea Puritan Institute</h4>
                <p>한국 청교도 연구소는 청교도 신학과 개혁주의 신념을 연구하고 성경적인 자료를 제공합니다.</p>
                <div class="social-links">
                    <a href="#" title="YouTube"><i class="fab fa-youtube"></i></a>
                    <a href="#" title="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="#" title="Naver Blog" class="naver-link">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16.273 12.845L7.376 0H0v24h7.727V11.155L16.624 24H24V0h-7.727v12.845z" />
                        </svg>
                    </a>
                </div>
            </div>
            <div class="footer-section">
                <h4>Contact Us</h4>
                <p>Email: kpuritan.phb@gmail.com</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2026 Korea Puritan Institute. All rights reserved.</p>
            <p style="margin-top: 10px; font-size: 0.8rem;">
                <a href="javascript:void(0)" onclick="document.getElementById('login-modal').classList.add('show')"
                    style="color: #666; text-decoration: none;">관리자 로그인</a>
            </p>
        </div>
    </footer>

    <!-- Login Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="login-close-btn">&times;</span>
            <h2>관리자 로그인</h2>
            <p>연구소 운영을 위한 관리자 계정으로 로그인해주세요.</p>
            <form id="login-form">
                <div class="input-group">
                    <label for="admin-id">아이디</label>
                    <input type="text" id="admin-id" placeholder="ID" required>
                </div>
                <div class="input-group">
                    <label for="admin-pw">비밀번호</label>
                    <input type="password" id="admin-pw" placeholder="Password" required>
                </div>
                <button type="submit" class="login-submit">로그인</button>
            </form>
        </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal" class="modal">
        <div class="modal-content about-modal-content">
            <span class="close-btn" id="about-close-btn">&times;</span>
            <div class="about-container modal-style">
                <div class="about-text">
                    <div class="section-title left">
                        <h2>연구소 소개</h2>
                    </div>
                    <p>한국 청교도 연구소는 성경의 절대적 권위와 하나님의 주권을 중심으로 한 개혁주의 신앙 전통 위에서, 청교도들의 신학과 경건, 그리고 목회적 유산을 연구하고 소개하기 위해
                        설립되었습니다.</p>
                    <p>청교도들은 단순한 과거의 신학자들이 아니라, 말씀에 의해 형성된 삶을 추구했던 신앙의 증인들이었습니다. 그들은 교리와 삶, 신학과 경건, 공적 예배와 개인의 신앙을 분리하지
                        않았으며, 오직 하나님의 영광(Soli Deo Gloria)을 목적으로 교회와 성도의 삶을 개혁하고자 했습니다.</p>

                    <p class="about-description-large">본 연구소는 청교도들의 설교, 신학 저작, 경건 문헌들을 번역·소개하고, 그 신학적 깊이와 목회적 통찰을 오늘의 한국
                        교회와 성도들에게 바르게 전달하고자 합니다.</p>

                    <p>우리는 청교도 신학이 단지 학문적 연구의 대상이 아니라, 오늘날에도 교회를 새롭게 하고 성도를 거룩으로 이끄는 살아 있는 유산임을 확신합니다.</p>
                    <p>한국 청교도 연구소는 웨스트민스터 신앙고백과 대·소요리문답으로 대표되는 개혁주의 신앙 고백 전통을 존중하며, 성경 중심적 설교, 언약 신학, 구원의 은혜 교리, 성화와 경건의
                        균형을 강조합니다.</p>
                    <p>우리는 새로운 것을 만들어내기보다, 이미 하나님께서 교회를 위해 허락하신 신실한 신앙의 유산을 다시 발견하고 충실히 계승하는 일에 헌신하고자 합니다. 오직 성경으로 돌아가고,
                        성경이 가르치는 바른 교리와 거룩한 삶을 회복하기를 소망합니다.</p>
                </div>

                <div class="about-right">
                    <!-- Background Illustration (Grayscale, Transparent, Frameless via crop) -->
                    <img src="images/puritan-study.png" class="about-bg-image" alt="Background Study Scene">

                    <div class="about-goals-container">
                        <h4>연구소의 지향점</h4>
                        <ul class="about-goals">
                            <li><i class="fas fa-check"></i> 설교자들이 성경을 더 깊이 이해하도록 돕습니다.</li>
                            <li><i class="fas fa-check"></i> 성도들이 하나님 앞에 경건하게 살도록 격려합니다.</li>
                            <li><i class="fas fa-check"></i> 한국 교회가 개혁주의 신앙의 뿌리를 회복하도록 섬깁니다.</li>
                        </ul>
                    </div>

                    <div class="about-team">
                        <span class="team-title">섬기는 이들</span>
                        <p class="team-name">청교도 개혁교회 연합회 복음 사역자들</p>
                        <span class="eng-team">The Alliance of Puritan and Reformed Churches</span>
                    </div>

                    <p
                        style="text-align: right; margin-top: 10px; font-weight: bold; font-size: 1.1rem; color: var(--primary-color);">
                        한국 청교도 연구소 소장 김홍만
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="edit-close-btn">&times;</span>
            <h2>자료 수정</h2>
            <form id="edit-form" class="upload-form">
                <input type="hidden" id="edit-post-id">
                <div class="admin-form-tags-grid">

                    <div class="input-group">
                        <label>주제별 분류</label>
                        <select id="edit-topic">
                            <option value="">-- 선택 안함 --</option>
                            <!-- Injected via JS -->
                        </select>
                    </div>
                    <div class="input-group">
                        <label>저자별 분류</label>
                        <select id="edit-author">
                        </select>
                    </div>
                    <div class="input-group">
                        <label>기타 분류 (최신자료 전용)</label>
                        <select id="edit-other-category">
                            <option value="">-- 선택 안함 --</option>
                            <option value="기타">기타 자료</option>
                            <option value="도서 목록">도서 목록</option>
                        </select>
                    </div>
                </div>
                <div class="input-group">
                    <label>제목</label>
                    <input type="text" id="edit-title" placeholder="자료 제목을 입력하세요">
                </div>
                <div class="input-row" style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                    <div class="input-group">
                        <label>시리즈/연재 이름 (폴더명)</label>
                        <input type="text" id="edit-series" placeholder="예: 사도행전 강해 시리즈">
                    </div>
                    <div class="input-group">
                        <label>정렬 순서</label>
                        <input type="number" id="edit-order">
                    </div>
                    <div class="input-group">
                        <label>가격 (도서 전용)</label>
                        <input type="text" id="edit-price" placeholder="예: 15,000원">
                    </div>
                </div>
                <div class="input-group">
                    <label>내용 (또는 유튜브 링크)</label>
                    <textarea id="edit-content" rows="6" placeholder="내용을 입력하거나 유튜브 주소를 넣어주세요"></textarea>
                </div>
                <div class="input-row"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 15px;">
                    <div class="input-group">
                        <label>도서 표지 교체</label>
                        <input type="file" id="edit-cover" accept="image/*">
                        <p id="edit-cover-status" style="font-size: 0.8em; color: var(--text-light); margin-top: 5px;">
                        </p>
                    </div>
                    <div class="input-group">
                        <label>상세 내용/파일 교체</label>
                        <input type="file" id="edit-file">
                        <p id="edit-file-status" style="font-size: 0.8em; color: var(--text-light); margin-top: 5px;">
                        </p>
                    </div>
                </div>

                <div class="form-row">
                    <button type="submit" class="cta-btn primary">수정 완료</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Resource List Modal -->
    <div id="resource-modal" class="modal">
        <div class="modal-content resource-modal-content">
            <span class="close-btn" id="resource-close-btn">&times;</span>
            <h2 id="resource-modal-title">자료 목록</h2>
            <div id="resource-modal-admin-header"
                style="display: none; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 700; color: var(--secondary-color);"><i class="fas fa-plus-circle"></i> 이
                        폴더에 새 자료 추가</span>
                    <div style="display: flex; gap: 8px;">
                        <button class="cta-btn" id="sort-alpha-btn"
                            style="padding: 5px 15px; font-size: 0.8rem; background: #eee; color: #333; border: 1px solid #ddd;">
                            <i class="fas fa-sort-alpha-down"></i> 가나다순 정렬</button>
                        <button class="cta-btn primary" id="toggle-modal-upload"
                            style="padding: 5px 15px; font-size: 0.8rem;">업로드 창 열기</button>
                    </div>
                </div>

                <form id="modal-upload-form" class="upload-form"
                    style="display: none; margin-top: 15px; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                    <input type="text" id="modal-post-title" placeholder="자료 제목"
                        style="width:100%; margin-bottom:10px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="modal-post-series" placeholder="시리즈 이름 (자동 입력됨)" style="flex: 2;">
                        <input type="number" id="modal-post-order" value="0" style="flex: 1;" placeholder="순서">
                    </div>
                    <textarea id="modal-post-content" rows="3" placeholder="내용 또는 유튜브 링크"
                        style="width:100%; margin-bottom:10px;"></textarea>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="file" id="modal-post-file" style="font-size: 0.8rem;">
                        <button type="submit" class="cta-btn primary"
                            style="flex-shrink: 0; padding: 8px 20px;">게시하기</button>
                    </div>
                    <div id="modal-upload-progress"
                        style="display:none; margin-top:10px; height:4px; background:#eee; border-radius:2px; overflow:hidden;">
                        <div id="modal-upload-bar"
                            style="width:0%; height:100%; background:var(--secondary-color); transition:width 0.3s;">
                        </div>
                    </div>
                </form>
            </div>

            <div class="resource-list-wrapper">
                <ul id="resource-list-container" class="resource-list">
                    <!-- Content injected via JS -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Music Player Container (Left) -->
    <div class="bgm-player" id="bgm-player"
        style="position: fixed; bottom: 2rem; left: 2rem; z-index: 1500; pointer-events: none;">
        <button id="bgm-toggle-btn" class="bgm-control" onclick="if(window.toggleBGM) window.toggleBGM(event)"
            style="pointer-events: auto;">
            <span class="music-icon"><i class="fas fa-music"></i></span>
            <span class="music-text">배경음악 On/Off</span>
        </button>
        <div id="yt-player-container" style="display: none;"></div>
    </div>

    <!-- Admin Floating Button (Right) -->
    <div id="admin-access-btn" class="login-trigger"
        onclick="document.getElementById('login-modal').classList.add('show')"
        style="position: fixed !important; bottom: 2rem !important; right: 2rem !important; z-index: 99999 !important; pointer-events: auto !important; cursor: pointer !important; display: flex !important;">
        <i class="fas fa-user-lock"></i> <span>관리자</span>
    </div>

    <!-- Drag and Drop Library -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

    <!-- PortOne SDK for actual payments -->
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <script src="data.js?v=20240118_v2"></script>
    <script>
        // --- Firebase Configuration (Migrated to HTML for Safety) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCJbOaiElCypwgtPgbwdnudn3VC737fMrs",
            authDomain: "kpuritan-home.firebaseapp.com",
            projectId: "kpuritan-home",
            storageBucket: "kpuritan-home.firebasestorage.app",
            messagingSenderId: "1071220455502",
            appId: "1:1071220455502:web:7f6f59b48c48a73437f8f0"
        };

        // Initialize Firebase Global Variables
        window.db = null;
        window.storage = null;
        window.isAdmin = false;
        window.useMock = false;

        try {
            if (firebase.apps.length === 0) {
                firebase.initializeApp(firebaseConfig);
                window.db = firebase.firestore();
                window.storage = firebase.storage();
                console.log("✅ Firebase (HTML) 연결 성공!");
                // alert("DEBUG: 1. Firebase (HTML) 연결 성공!"); 
            }
        } catch (e) {
            console.error("❌ Firebase 초기화 실패:", e);
            // alert("DEBUG: Firebase 초기화 실패: " + e.message);
            window.useMock = true;
        }

        window.onerror = function (msg, url, lineNo, columnNo, error) {
            alert('자바스크립트 에러 발생:\n' + msg + '\n라인: ' + lineNo);
            return false;
        };

        // --- Core Logic Inlined (Emergency Fix) ---
        window.isDataLoaded = false;

        // Simplified Modal Opener (Inline)
        window.openResourceModal = (category, series, docId) => {
            const modal = document.getElementById('resource-modal');
            const list = document.getElementById('resource-list-container');
            const title = document.getElementById('resource-modal-title');

            if (modal && list) {
                if (window.openModal) {
                    window.openModal(modal);
                } else {
                    modal.classList.add('show');
                }
                if (title) title.textContent = (series || category) + " 자료 목록";
                list.innerHTML = '<li class="no-resource-msg">자료를 불러오는 중입니다...</li>';

                // Fetch specific resource or list
                if (window.db) {
                    let query = window.db.collection("posts");
                    if (series) {
                        query = query.where("series", "==", series);
                    } else {
                        query = query.where("tags", "array-contains", category);
                    }

                    query.orderBy("createdAt", "desc").limit(20).get().then(snap => {
                        if (!snap.empty) {
                            list.innerHTML = '';
                            snap.forEach(doc => {
                                const item = doc.data();
                                const li = document.createElement('li');
                                li.className = 'resource-item';

                                // Link Check
                                let linkHtml = '';
                                const fileUrl = item.fileUrl || item.downloadUrl;
                                if (fileUrl) linkHtml += `<a href="${fileUrl}" target="_blank" class="download-btn"><i class="fas fa-file-download"></i> 다운로드</a>`;
                                if (item.youtubeLink) linkHtml += `<a href="${item.youtubeLink}" target="_blank" class="download-btn youtube"><i class="fab fa-youtube"></i> 영상 보기</a>`;
                                if (!linkHtml) linkHtml = `<span style="color:#999; font-size:0.8rem;">첨부 파일 없음</span>`;

                                li.innerHTML = `
                                    <div class="resource-header">
                                        <span class="resource-category">${item.series || item.tags[0]}</span>
                                        <span class="resource-date">${item.createdAt ? item.createdAt.toDate().toLocaleDateString() : ''}</span>
                                    </div>
                                    <h3 class="resource-title">${item.title}</h3>
                                    <div class="resource-link-container">
                                        ${linkHtml}
                                    </div>
                                    <div class="resource-content">${item.content || ''}</div>
                                 `;
                                list.appendChild(li);
                            });
                        } else {
                            list.innerHTML = '<li class="no-resource-msg">해당 분류에 등록된 자료가 없습니다.</li>';
                        }
                    }).catch(err => {
                        list.innerHTML = '<li class="no-resource-msg">자료 로딩 실패: ' + err.message + '</li>';
                    });
                } else {
                    list.innerHTML = '<li class="no-resource-msg">DB 연결이 되어있지 않습니다.</li>';
                }
            }
        };

        window.createCarouselCard = (post, docId) => {
            const date = post.createdAt ? post.createdAt.toDate().toLocaleDateString() : '최근';
            const displayCategory = post.tags ? post.tags[0] : '자료';
            const thumbUrl = post.coverUrl || '';

            const div = document.createElement('div');
            div.className = 'carousel-card' + (thumbUrl ? ' has-thumb' : '');

            if (thumbUrl) {
                div.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.7)), url("${thumbUrl}")`;
                div.style.backgroundSize = 'cover';
                div.style.backgroundPosition = 'center';
                div.style.color = 'white';
            }

            div.innerHTML = `
                <div class="carousel-card-content">
                    <div class="carousel-card-tag" style="${thumbUrl ? 'background: var(--secondary-color); color: white;' : ''}">${displayCategory}</div>
                    <div class="carousel-card-title">${post.title}</div>
                    <div class="carousel-card-meta">
                        <span style="${thumbUrl ? 'color: rgba(255,255,255,0.8);' : ''}">${date}</span>
                        <div class="carousel-icon-btn" style="${thumbUrl ? 'background: white; color: var(--primary-color);' : ''}"><i class="fas fa-arrow-right"></i></div>
                    </div>
                </div>
            `;
            div.addEventListener('click', () => {
                if (window.openResourceModal) {
                    window.openResourceModal(displayCategory, post.series || '', docId);
                } else {
                    console.warn("Main Script Not Loaded - Basic Alert");
                }
            });
            return div;
        };

        window.loadMainCarousels = async () => {
            if (!window.db) return;

            const latestIds = new Set();
            window.isDataLoaded = true;

            // 1. New Arrivals (Latest 15)
            const newTrack = document.getElementById('carousel-new');
            if (newTrack) {
                try {
                    const snapshot = await window.db.collection("posts").orderBy("createdAt", "desc").limit(15).get();
                    if (!snapshot.empty) {
                        newTrack.innerHTML = '';
                        snapshot.forEach(doc => {
                            latestIds.add(doc.id);
                            newTrack.appendChild(window.createCarouselCard(doc.data(), doc.id));
                        });
                    }
                } catch (e) { console.error("New Arrival Error:", e); }
            }

            // 2. Featured Topics (Randomly pick 12 from latest 40 '청교도 신학' posts, excluding new arrivals)
            const topicTrack = document.getElementById('carousel-topic');
            if (topicTrack) {
                try {
                    const snapshot = await window.db.collection("posts")
                        .where("tags", "array-contains", "청교도 신학")
                        .orderBy("createdAt", "desc")
                        .limit(40).get();

                    if (!snapshot.empty) {
                        topicTrack.innerHTML = '';
                        const items = [];
                        snapshot.forEach(doc => {
                            if (!latestIds.has(doc.id)) {
                                items.push({ id: doc.id, data: doc.data() });
                            }
                        });
                        const selected = items.sort(() => 0.5 - Math.random()).slice(0, 15);
                        selected.forEach(item => {
                            topicTrack.appendChild(window.createCarouselCard(item.data, item.id));
                        });
                    }
                } catch (e) { console.error("Topic Error:", e); }
            }

            // 3. Expository Sermons (Latest 20 '강해설교' posts)
            const sermonTrack = document.getElementById('carousel-sermon');
            if (sermonTrack) {
                try {
                    const snapshot = await window.db.collection("posts")
                        .where("tags", "array-contains", "강해설교")
                        .orderBy("createdAt", "desc")
                        .limit(20).get();

                    if (!snapshot.empty) {
                        sermonTrack.innerHTML = '';
                        snapshot.forEach(doc => {
                            sermonTrack.appendChild(window.createCarouselCard(doc.data(), doc.id));
                        });
                    } else {
                        // Fallback: If no '강해설교' tag found, try '설교' tag
                        const fallbackSnap = await window.db.collection("posts")
                            .where("tags", "array-contains", "설교")
                            .orderBy("createdAt", "desc")
                            .limit(20).get();

                        if (!fallbackSnap.empty) {
                            sermonTrack.innerHTML = '';
                            fallbackSnap.forEach(doc => {
                                sermonTrack.appendChild(window.createCarouselCard(doc.data(), doc.id));
                            });
                        }
                    }
                } catch (e) { console.error("Sermon Error:", e); }
            }
        };

        // Auto-run if DB connected
        if (window.db) {
            setTimeout(window.loadMainCarousels, 100);
        }
    </script>
    <script src="main.js?v=20240118_v11"></script>
</body>

</html>